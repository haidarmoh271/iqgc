<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>IQGC EVENT â€” Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“º</text></svg>"/>
<script src="/socket.io/socket.io.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&family=Oswald:wght@700&display=swap" rel="stylesheet"/>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Syne:wght@700;800&family=Tajawal:wght@400;700;900&display=swap');

:root{
  --purple:#7c3aed;
  --purple-light:#a78bfa;
  --purple-glow:rgba(124,58,237,0.5);
  --bg:#0a0010;
}

*{margin:0;padding:0;box-sizing:border-box;}

body{
  font-family:'Tajawal',sans-serif;
  background:var(--bg);
  color:#fff;
  min-height:100vh;
  overflow:hidden;
}

/* â”€â”€ Animated Background â”€â”€ */
.scene-bg{
  position:fixed;inset:0;z-index:0;
  background:
    radial-gradient(ellipse 100% 60% at 50% -5%, rgba(124,58,237,0.4) 0%, transparent 65%),
    radial-gradient(ellipse 50% 50% at 95% 90%, rgba(109,40,217,0.25) 0%, transparent 55%),
    radial-gradient(ellipse 40% 40% at 5% 80%, rgba(167,139,250,0.15) 0%, transparent 55%),
    #0a0010;
}
.grid-lines{
  position:fixed;inset:0;z-index:0;
  background-image:
    linear-gradient(rgba(124,58,237,0.07) 1px, transparent 1px),
    linear-gradient(90deg, rgba(124,58,237,0.07) 1px, transparent 1px);
  background-size:70px 70px;
  animation:gridMove 20s linear infinite;
}
@keyframes gridMove{from{background-position:0 0;}to{background-position:0 70px;}}

.orb{position:fixed;border-radius:50%;filter:blur(90px);pointer-events:none;z-index:0;}
.orb1{width:600px;height:600px;background:rgba(124,58,237,0.15);top:-200px;right:-150px;animation:drift 15s ease-in-out infinite;}
.orb2{width:400px;height:400px;background:rgba(167,139,250,0.1);bottom:-100px;left:-100px;animation:drift 20s ease-in-out infinite reverse;}
@keyframes drift{0%,100%{transform:translate(0,0);}50%{transform:translate(40px,50px);}}

/* â”€â”€ Screens â”€â”€ */
#joinScreen,#lobbyScreen,#countdownScreen,#questionScreen,
#resultsScreen,#lbScreen,#finalScreen{
  display:none;
  position:relative;z-index:2;
}

/* â”€â”€ Join Screen â”€â”€ */
#joinScreen{
  height:100vh;align-items:center;justify-content:center;flex-direction:column;gap:2rem;
}
.brand{
  font-family:'Bebas Neue',sans-serif;
  font-size:3rem;letter-spacing:0.4em;
  background:linear-gradient(135deg,#fff,var(--purple-light));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.join-card{
  background:rgba(255,255,255,0.04);
  border:1px solid rgba(124,58,237,0.3);
  border-radius:20px;padding:2.5rem;
  width:400px;text-align:center;
  box-shadow:0 0 60px rgba(124,58,237,0.15);
}
.join-card h2{font-family:'Syne',sans-serif;font-size:1.4rem;margin-bottom:0.5rem;}
.join-card p{color:rgba(167,139,250,0.6);font-size:0.85rem;letter-spacing:0.15em;margin-bottom:1.5rem;}
.code-input{
  width:100%;padding:1rem;font-size:2rem;text-align:center;letter-spacing:0.4em;
  background:rgba(255,255,255,0.05);border:1px solid rgba(124,58,237,0.4);
  border-radius:10px;color:#fff;font-family:'Bebas Neue',sans-serif;outline:none;
  transition:border-color 0.2s;
}
.code-input:focus{border-color:var(--purple-light);}
.err-msg{display:none;color:#ef4444;font-size:0.8rem;margin-top:0.5rem;letter-spacing:0.1em;}
.btn-join{
  margin-top:1rem;width:100%;padding:0.9rem;
  background:linear-gradient(135deg,var(--purple),#6d28d9);
  color:#fff;border:none;border-radius:10px;
  font-size:0.95rem;letter-spacing:0.2em;font-family:'Tajawal',sans-serif;font-weight:700;
  cursor:pointer;transition:all 0.2s;
  box-shadow:0 4px 20px rgba(124,58,237,0.4);
}
.btn-join:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(124,58,237,0.6);}

/* â”€â”€ Lobby Screen â”€â”€ */
#lobbyScreen{
  height:100vh;
  flex-direction:column;
  align-items:center;
  justify-content:space-between;
  padding:2.5vh 4vw 2.5vh;
}

.lobby-header{
  width:100%;display:flex;align-items:center;justify-content:center;
  padding-top:0.5rem;
}
.lobby-title{
  font-family:'Bebas Neue',sans-serif;
  font-size:2.8rem;letter-spacing:0.5em;
  background:linear-gradient(135deg,#fff 40%,var(--purple-light));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  filter:drop-shadow(0 0 30px rgba(124,58,237,0.4));
}

.lobby-main{
  flex:1;display:flex;align-items:center;justify-content:center;
}

/* QR card */
.qr-card{
  background:#fff;
  border-radius:28px;
  padding:2.2rem 2.5rem;
  display:flex;flex-direction:column;align-items:center;gap:1rem;
  box-shadow:0 0 0 1px rgba(124,58,237,0.3), 0 40px 100px rgba(0,0,0,0.7), 0 0 80px rgba(124,58,237,0.2);
  position:relative;
}
/* purple top glow line */
.qr-card::before{
  content:'';position:absolute;top:-1px;left:15%;right:15%;height:2px;
  background:linear-gradient(90deg,transparent,var(--purple),var(--purple-light),var(--purple),transparent);
  border-radius:2px;
}
.qr-label{
  font-family:'Syne',sans-serif;
  font-size:1.1rem;font-weight:800;
  color:#1a0030;letter-spacing:0.12em;
}
.qr-code-num{
  font-family:'Bebas Neue',sans-serif;
  font-size:3.2rem;letter-spacing:0.55em;
  color:#1a0030;
}

/* pulse ring on QR */
.qr-wrap{position:relative;}
.qr-wrap::after{
  content:'';position:absolute;inset:-8px;
  border-radius:16px;
  border:2px solid var(--purple);
  opacity:0.3;
  animation:qrPulse 3s ease-in-out infinite;
}
@keyframes qrPulse{0%,100%{opacity:0.15;transform:scale(1);}50%{opacity:0.5;transform:scale(1.02);}}

/* â”€â”€ Sponsors â”€â”€ */
.sponsors-section{
  width:100%;
  display:flex;flex-direction:column;align-items:center;gap:0.8rem;
  padding-bottom:0.5rem;
}
.sponsored-label{
  font-family:'Bebas Neue',sans-serif;
  font-size:0.85rem;letter-spacing:0.7em;
  color:rgba(124,58,237,0.5);
  position:relative;
  padding:0 1.5rem;
}
.sponsored-label::before,.sponsored-label::after{
  content:'';position:absolute;top:50%;width:60px;height:1px;
  background:linear-gradient(90deg,transparent,rgba(124,58,237,0.4));
}
.sponsored-label::before{right:100%;margin-right:-1.5rem;}
.sponsored-label::after{left:100%;margin-left:-1.5rem;transform:scaleX(-1);}

.sponsors-row{
  display:flex;align-items:center;justify-content:center;gap:2rem;
}
.sponsor-box{
  width:150px;height:65px;
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(124,58,237,0.2);
  border-radius:14px;
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;position:relative;
  transition:border-color 0.3s;
}
.sponsor-box::before{
  content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(124,58,237,0.5),transparent);
}
.sponsor-box img{
  max-width:85%;max-height:80%;
  object-fit:contain;
  filter:brightness(0) invert(1);
  opacity:0.65;
}
.ig-handles{
  display:flex;align-items:center;justify-content:center;gap:3rem;
}
.ig-handle{
  font-size:0.78rem;color:rgba(167,139,250,0.45);
  letter-spacing:0.15em;text-decoration:none;
  transition:color 0.2s;
  display:flex;align-items:center;gap:0.4rem;
}
.ig-handle svg{opacity:0.6;}

/* â”€â”€ Countdown â”€â”€ */
#countdownScreen{
  height:100vh;align-items:center;justify-content:center;
}
.countdown-num{
  font-family:'Bebas Neue',sans-serif;
  font-size:30vw;color:#fff;
  animation:popIn 0.4s cubic-bezier(0.34,1.56,0.64,1);
  text-shadow:0 0 80px var(--purple-glow);
}
@keyframes popIn{from{transform:scale(0.5);opacity:0;}to{transform:scale(1);opacity:1;}}

/* â”€â”€ Question â”€â”€ */
#questionScreen{
  height:100vh;flex-direction:column;
}
.q-topbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:1rem 2rem;background:rgba(124,58,237,0.1);
  border-bottom:1px solid rgba(124,58,237,0.2);
}
.q-counter{
  font-family:'Bebas Neue',sans-serif;
  font-size:1.5rem;letter-spacing:0.2em;color:var(--purple-light);
}
.timer-display{
  font-family:'Bebas Neue',sans-serif;
  font-size:3rem;color:#fff;
  min-width:60px;text-align:center;
}
.q-body{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2rem;gap:2rem;}
.q-image-display{max-height:25vh;border-radius:12px;display:none;}
.q-text-display{
  font-family:'Syne',sans-serif;
  font-size:3.5vw;font-weight:800;text-align:center;
  max-width:1000px;line-height:1.3;color:#fff;
}
.answers-grid-display{
  display:grid;grid-template-columns:1fr 1fr;
  gap:1rem;width:100%;max-width:1100px;
}
.ans-display{
  padding:1.2rem 2rem;border-radius:14px;
  font-family:'Syne',sans-serif;font-size:1.6vw;font-weight:700;
  color:#fff;display:flex;align-items:center;gap:1rem;
  border:1px solid rgba(255,255,255,0.1);
}

/* â”€â”€ Results â”€â”€ */
#resultsScreen{
  height:100vh;flex-direction:column;align-items:center;justify-content:center;
  gap:2rem;padding:2rem;
}
.results-title{
  font-family:'Bebas Neue',sans-serif;
  font-size:3rem;letter-spacing:0.3em;color:var(--purple-light);
}
.results-answers{width:100%;max-width:900px;display:flex;flex-direction:column;gap:0.8rem;}

/* â”€â”€ Leaderboard â”€â”€ */
#lbScreen{
  height:100vh;flex-direction:column;align-items:center;justify-content:center;
  gap:1.5rem;padding:2rem;
}
.lb-title-big{
  font-family:'Bebas Neue',sans-serif;
  font-size:4rem;letter-spacing:0.3em;
  background:linear-gradient(135deg,#fff,var(--purple-light));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}

/* â”€â”€ Final â”€â”€ */
#finalScreen{
  height:100vh;flex-direction:column;align-items:center;justify-content:center;
  gap:1.5rem;padding:2rem;
}
.final-title{
  font-family:'Bebas Neue',sans-serif;
  font-size:5rem;letter-spacing:0.3em;
  background:linear-gradient(135deg,#ffd700,#fff,var(--purple-light));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.podium-display{display:flex;align-items:flex-end;justify-content:center;gap:1.5rem;}

/* â”€â”€ Reaction float â”€â”€ */
@keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1);}100%{opacity:0;transform:translateY(-250px) scale(2.5);}}

/* â”€â”€ Pause overlay â”€â”€ */
#displayPause{display:flex;align-items:center;justify-content:center;flex-direction:column;gap:1rem;}

/* show utility */
.shown{display:flex !important;}
</style>
</head>
<body>
<div class="scene-bg"></div>
<div class="grid-lines"></div>
<div class="orb orb1"></div>
<div class="orb orb2"></div>

<!-- Join -->
<div id="joinScreen">
  <div class="brand">IQGC EVENT</div>
  <div class="join-card">
    <h2>ğŸ“º Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶</h2>
    <p>Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‡Ø§</p>
    <input class="code-input" id="codeInput" maxlength="6" placeholder="XXXX"
      onkeydown="if(event.key==='Enter')joinDisplay()"
      oninput="this.value=this.value.toUpperCase()"/>
    <div class="err-msg" id="errMsg">Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© âŒ</div>
    <button class="btn-join" onclick="joinDisplay()">Ø§ØªØµØ§Ù„ ğŸ“º</button>
  </div>
</div>

<!-- Lobby -->
<div id="lobbyScreen">
  <!-- Header -->
  <div class="lobby-header">
    <div class="lobby-title">IQGC &nbsp;EVENT</div>
  </div>

  <!-- QR -->
  <div class="lobby-main">
    <div class="qr-card">
      <div class="qr-label">ğŸ“± Ø§Ù…Ø³Ø­ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</div>
      <div class="qr-wrap">
        <img id="lobbyQR" width="520" height="520" style="border-radius:12px;display:block;" alt="QR"/>
      </div>
      <div class="qr-code-num" id="lobbyCodeBig">----</div>
    </div>
  </div>

  <!-- Sponsors -->
  <div class="sponsors-section">
    <div class="sponsored-label">SPONSORED BY</div>
    <div class="sponsors-row">
      <div class="sponsor-box">
        <img src="/sponsor1.png" alt="S1" onerror="this.style.display='none'"/>
      </div>
      <div class="sponsor-box">
        <img src="/sponsor2.png" alt="S2" onerror="this.style.display='none'"/>
      </div>
      <div class="sponsor-box">
        <img src="/sponsor3.png" alt="S3" onerror="this.style.display='none'"/>
      </div>
    </div>
    <div class="ig-handles">
      <a href="#" class="ig-handle">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5"/><circle cx="12" cy="12" r="4"/><circle cx="17.5" cy="6.5" r="1.5" fill="currentColor" stroke="none"/></svg>
        @sponsor1
      </a>
      <a href="#" class="ig-handle">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5"/><circle cx="12" cy="12" r="4"/><circle cx="17.5" cy="6.5" r="1.5" fill="currentColor" stroke="none"/></svg>
        @sponsor2
      </a>
      <a href="#" class="ig-handle">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5"/><circle cx="12" cy="12" r="4"/><circle cx="17.5" cy="6.5" r="1.5" fill="currentColor" stroke="none"/></svg>
        @sponsor3
      </a>
    </div>
  </div>
</div>

<!-- Countdown -->
<div id="countdownScreen">
  <div class="countdown-num" id="cdNum">3</div>
</div>

<!-- Question -->
<div id="questionScreen">
  <div class="q-topbar">
    <div class="q-counter" id="qCounterD">Ø³Ø¤Ø§Ù„ 1/1</div>
    <div class="timer-display" id="timerD">20</div>
  </div>
  <div class="q-body">
    <img id="qImgD" class="q-image-display"/>
    <div class="q-text-display" id="qTextD"></div>
    <div class="answers-grid-display" id="answersGridD"></div>
  </div>
</div>

<!-- Results -->
<div id="resultsScreen">
  <div class="results-title">ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø³Ø¤Ø§Ù„</div>
  <div class="results-answers" id="resultsAnswersD"></div>
</div>

<!-- Leaderboard -->
<div id="lbScreen">
  <div class="lb-title-big">ğŸ† Ø§Ù„Ù…ØªØµØ¯Ø±ÙˆÙ†</div>
  <div id="lbRowsD" style="width:100%;max-width:900px;display:flex;flex-direction:column;gap:0.8rem"></div>
</div>

<!-- Final -->
<div id="finalScreen">
  <div class="final-title">ğŸ† Ø§Ù„Ù†Ù‡Ø§ÙŠØ©!</div>
  <div class="podium-display" id="podiumD"></div>
  <div id="finalListD" style="display:flex;flex-direction:column;gap:0.6rem;width:100%;max-width:700px"></div>
</div>

<!-- Ad Overlay -->
<div id="adOverlayD" style="display:none;position:fixed;inset:0;background:#000;z-index:999;">
  <video id="adVideoD" style="position:absolute;inset:0;width:100%;height:100%;object-fit:contain;background:#000;" autoplay playsinline>
    <source id="adVideoSrcD" src="" type="video/mp4"/>
  </video>
  <div style="position:absolute;inset:0;display:flex;flex-direction:column;justify-content:space-between;pointer-events:none;">
    <div style="padding:1.5rem 2rem;background:linear-gradient(rgba(0,0,0,0.6),transparent);">
      <div id="adTextD" style="font-family:'Tajawal',sans-serif;font-size:2rem;font-weight:900;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,0.8)"></div>
    </div>
    <div style="padding:1rem 2rem 2rem;background:linear-gradient(transparent,rgba(0,0,0,0.7));">
      <div style="height:4px;background:rgba(255,255,255,0.2);border-radius:2px;overflow:hidden">
        <div id="adBarD" style="height:100%;background:#fff;width:100%;border-radius:2px;transition:width linear"></div>
      </div>
      <div id="adCounterD" style="font-size:0.9rem;color:rgba(255,255,255,0.5);margin-top:0.5rem;letter-spacing:0.1em"></div>
    </div>
  </div>
</div>

<script>
const socket = io();
const COLORS = ['#e21b3c','#1368ce','#d89e00','#26890c'];
const SHAPES = ['â–²','â—†','â—','âœ¦'];
const MEDALS = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
let myCode = '';
let timerInterval = null;

function show(id){
  ['joinScreen','lobbyScreen','countdownScreen','questionScreen','resultsScreen','lbScreen','finalScreen']
    .forEach(s=>{
      const el = document.getElementById(s);
      el.style.display = 'none';
    });
  const target = document.getElementById(id);
  target.style.display = 'flex';
}

function joinDisplay(){
  const code = document.getElementById('codeInput').value.trim().toUpperCase();
  if(!code){return;}
  myCode = code;
  socket.emit('display:join', {code});
}

socket.on('display:error', (msg)=>{
  const err = document.getElementById('errMsg');
  err.textContent = msg + ' âŒ';
  err.style.display = 'block';
});

socket.on('display:joined', ({code, title})=>{
  document.getElementById('lobbyCodeBig').textContent = code;
  const titleEl = document.getElementById('quizTitleDisplay'); if(titleEl) titleEl.textContent = title || '';
  // QR ÙŠØ´ÙŠØ± Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù„Ø¹Ø¨Ø©
  const playUrl = location.protocol + '//' + location.host + '/play.html?code=' + code;
  const qrImg = document.getElementById('lobbyQR');
  qrImg.src = '/qr?url=' + encodeURIComponent(playUrl);
  show('lobbyScreen');
});

// â”€â”€ Ø±Ø¯ÙˆØ¯ ÙØ¹Ù„ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± â”€â”€
socket.on('display:reaction', ({emoji, name})=>{
  const el = document.createElement('div');
  el.style.cssText = 'position:fixed;font-size:3.5rem;pointer-events:none;z-index:500;left:'+(10+Math.random()*80)+'%;bottom:10%;animation:floatUp 2.5s ease-out forwards;';
  el.textContent = emoji;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 2500);
});

// â”€â”€ ÙƒÙ„ Ø´ÙŠØ¡ ÙŠØ£ØªÙŠ Ù…Ù† Ø§Ù„Ù…Ø¶ÙŠÙ Ø¹Ø¨Ø± display:sync â”€â”€
socket.on('display:sync', ({action, data})=>{
  if(action === 'paused'){
    // overlay pause on display
    let po = document.getElementById('displayPause');
    if(!po){
      po = document.createElement('div');
      po.id = 'displayPause';
      po.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:400;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:1rem;';
      po.innerHTML = '<div style="font-size:5rem">â¸</div><div style="font-family:Oswald,sans-serif;font-size:2rem;letter-spacing:0.3em;color:#fbbf24">Ù…ØªÙˆÙ‚Ù Ù…Ø¤Ù‚ØªØ§Ù‹</div>';
      document.body.appendChild(po);
    }
    clearInterval(timerInterval);
  } else if(action === 'resumed'){
    const po = document.getElementById('displayPause');
    if(po) po.remove();
  } else if(action === 'question'){
    clearInterval(timerInterval);
    const po = document.getElementById('displayPause');
    if(po) po.remove();
    showQuestion(data.index, data.total, data.question, data.answers, data.time, data.image);
  }
  else if(action === 'results'){
    clearInterval(timerInterval);
    showResults(data);
  }
  else if(action === 'ad'){
    showDisplayAd(data, ()=>{});
  }
  else if(action === 'adEnd'){
    clearInterval(window._adTimerD);
    document.getElementById('adOverlayD').style.display = 'none';
    const v = document.getElementById('adVideoD');
    if(v){ v.pause(); v.src=''; }
  }
  else if(action === 'end'){
    clearInterval(timerInterval);
    showFinal(data.final);
  }
});

function showQuestion(index, total, question, answers, time, image){
  document.getElementById('qCounterD').textContent = `Ø³Ø¤Ø§Ù„ ${index+1} / ${total}`;
  document.getElementById('qTextD').textContent = question;

  const img = document.getElementById('qImgD');
  if(image){ img.src = image; img.style.display = 'block'; }
  else { img.style.display = 'none'; }

  // Ø±Ø³Ù… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
  const grid = document.getElementById('answersGridD');
  grid.innerHTML = answers.map((a,i)=>`
    <div class="ans-display" style="background:${COLORS[i]}22;border-color:${COLORS[i]}66;">
      <div class="icon" style="background:${COLORS[i]}">${SHAPES[i]}</div>
      <span>${a}</span>
    </div>
  `).join('');

  show('questionScreen');

  // ØªØ§ÙŠÙ…Ø±
  let t = time;
  const timerEl = document.getElementById('timerD');
  timerEl.textContent = t;
  timerEl.className = 'timer-display';
  timerInterval = setInterval(()=>{
    t--;
    timerEl.textContent = t;
    if(t <= 5) timerEl.className = 'timer-display urgent';
    if(t <= 0){ clearInterval(timerInterval); }
  }, 1000);
}

function showDisplayAd(ad, onDone){
  let done = false;
  const finish = ()=>{
    if(done) return; done = true;
    clearInterval(window._adTimerD);
    document.getElementById('adOverlayD').style.display = 'none';
    const v = document.getElementById('adVideoD');
    v.pause(); v.src = '';
    onDone();
  };
  const overlay = document.getElementById('adOverlayD');
  overlay.style.display = 'block';
  document.getElementById('adTextD').textContent = ad.text || '';
  const video = document.getElementById('adVideoD');
  const src = document.getElementById('adVideoSrcD');
  src.src = ad.videoUrl;
  video.load();
  video.onended = ()=> finish();
  video.onerror = ()=> setTimeout(finish, 3000);
  video.play().catch(()=> setTimeout(finish, 3000));
  video.onloadedmetadata = ()=>{
    const dur = Math.round(video.duration) || 15;
    const bar = document.getElementById('adBarD');
    bar.style.transition = 'none'; bar.style.width = '100%';
    setTimeout(()=>{ bar.style.transition = `width ${dur}s linear`; bar.style.width = '0%'; }, 50);
    let t = dur;
    document.getElementById('adCounterD').textContent = `ÙŠØ³ØªÙ…Ø± ${t} Ø«Ø§Ù†ÙŠØ©`;
    window._adTimerD = setInterval(()=>{
      t--;
      document.getElementById('adCounterD').textContent = t > 0 ? `ÙŠØ³ØªÙ…Ø± ${t} Ø«Ø§Ù†ÙŠØ©` : '';
      if(t <= 0) finish();
    }, 1000);
  };
}

function showResults({correct, stats, leaderboard, answers}){
  const total = stats.reduce((a,s)=>a+s.count,0)||1;
  const container = document.getElementById('resultsAnswersD');
  container.innerHTML = answers.map((a,i)=>{
    const s = stats[i];
    const pct = Math.round((s.count/total)*100);
    const isCorrect = i === correct;
    return `
      <div class="res-card" style="
        background:${isCorrect ? COLORS[i]+'33' : COLORS[i]+'15'};
        border-color:${isCorrect ? COLORS[i] : COLORS[i]+'44'};
        ${isCorrect ? 'box-shadow:0 0 30px '+COLORS[i]+'44' : ''};
        animation:fadeIn 0.4s ease ${i*0.1}s both;
      ">
        <div class="icon" style="background:${COLORS[i]};${isCorrect?'box-shadow:0 0 16px '+COLORS[i]+'88':''}">
          ${isCorrect ? 'âœ“' : SHAPES[i]}
        </div>
        <div class="res-info">
          <div class="res-text">${a}</div>
          <div class="res-votes">${s.count} ØµÙˆØª</div>
        </div>
        <div class="res-pct" style="color:${isCorrect?'#22c55e':'#555'}">${pct}%</div>
      </div>
    `;
  }).join('');
  show('resultsScreen');

  // Ø³ÙƒÙˆØ±Ø¨ÙˆØ±Ø¯ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
  setTimeout(()=>{
    const lbEl = document.getElementById('lbRowsD');
    lbEl.innerHTML = leaderboard.slice(0,5).map((p,i)=>`
      <div class="lb-row-big" style="
        background:${i===0?'rgba(255,215,0,0.12)':i===1?'rgba(192,192,192,0.08)':i===2?'rgba(205,127,50,0.08)':'rgba(255,255,255,0.05)'};
        border:1px solid ${i===0?'rgba(255,215,0,0.3)':'rgba(255,255,255,0.08)'};
        animation-delay:${i*0.12}s;
      ">
        <span class="lb-medal">${MEDALS[i]||('#'+(i+1))}</span>
        <span class="lb-name-big">${p.name}</span>
        <span class="lb-score-big" style="color:${i===0?'#ffd700':i===1?'#c0c0c0':i===2?'#cd7f32':'#fff'}">${p.score.toLocaleString()}</span>
      </div>
    `).join('');
    show('lbScreen');
  }, 3000);
}

function showFinal(final){
  const top3 = final.slice(0,3);
  const order = [1,0,2];
  const heights = ['140px','180px','110px'];
  const colors = ['rgba(192,192,192,0.15)','rgba(255,215,0,0.2)','rgba(205,127,50,0.15)'];
  document.getElementById('podiumD').innerHTML = order.map((rank,col)=>{
    const p = top3[rank]; if(!p) return '';
    return `<div class="pod-display" style="height:${heights[col]};background:${colors[col]};width:160px;">
      <span style="font-size:2.5rem">${MEDALS[rank]||''}</span>
      <span style="font-size:1.2rem;font-weight:700;text-align:center">${p.name}</span>
      <span style="font-family:'Oswald',sans-serif;font-size:1.5rem;color:#ffd700">${p.score.toLocaleString()}</span>
    </div>`;
  }).join('');
  document.getElementById('finalListD').innerHTML = final.map((p,i)=>`
    <div style="display:flex;align-items:center;gap:1rem;
      background:${i<3?'rgba(255,255,255,0.07)':'rgba(255,255,255,0.03)'};
      border-radius:10px;padding:0.9rem 1.5rem;">
      <span style="font-size:1.5rem;width:40px;text-align:center">${MEDALS[i]||('#'+(i+1))}</span>
      <span style="flex:1;font-size:1.2rem;font-weight:700">${p.name}</span>
      <span style="font-family:'Oswald',sans-serif;font-size:1.4rem;color:#ffd700">${p.score.toLocaleString()}</span>
    </div>
  `).join('');
  show('finalScreen');
}
</script>
</body>
</html>
